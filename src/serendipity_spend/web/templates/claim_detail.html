{% extends "base.html" %}
{% block content %}
  {% set oob = false %}
  {% include "claim_detail/_header.html" %}
  {% include "claim_detail/_alerts.html" %}

  <!-- Two column layout -->
  <div class="workspace">
    
    <!-- Main column -->
    <div class="workspace-main">

      <!-- Step 1: Trip Info (compact when filled, expandable) -->
      <details class="step-card" {% if not claim.purpose or not claim.travel_start_date %}open{% endif %}>
        <summary class="step-header">
          <span class="step-number">1</span>
          <span class="step-title">Trip details</span>
          {% if claim.purpose and claim.travel_start_date and claim.travel_end_date %}
            <span class="pill ok" style="margin-left: auto;">Complete</span>
          {% else %}
            <span class="pill warn" style="margin-left: auto;">Required</span>
          {% endif %}
        </summary>
        <div class="step-body">
          <form
            id="trip-form"
            method="post"
            action="/app/claims/{{ claim.id }}/update"
            class="compact-form"
            hx-post="/app/claims/{{ claim.id }}/update"
            hx-trigger="keyup changed delay:800ms, change changed delay:200ms, submit"
            hx-target="#trip-status"
            hx-swap="innerHTML"
            hx-indicator="#trip-saving"
          >
            <div class="form-grid-3">
              <div class="form-field">
                <label>Start</label>
                <input type="date" name="travel_start_date" value="{{ claim.travel_start_date or '' }}" />
              </div>
              <div class="form-field">
                <label>End</label>
                <input type="date" name="travel_end_date" value="{{ claim.travel_end_date or '' }}" />
              </div>
              <div class="form-field">
                <label>Purpose</label>
                <input name="purpose" value="{{ claim.purpose or '' }}" placeholder="e.g. Client meetings in Singapore" />
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-sm" type="submit">Save</button>
              <span id="trip-saving" class="muted htmx-indicator" style="font-size:12px;">Saving…</span>
              <span id="trip-status" class="muted" style="font-size:12px;"></span>
            </div>
          </form>
        </div>
      </details>

      <!-- Step 2: Upload Receipts -->
      <div class="step-card">
        <div class="step-header">
          <span class="step-number">2</span>
          <span class="step-title">Upload receipts</span>
          {% with oob=false %}
            {% include "claim_detail/_docs_count.html" %}
          {% endwith %}
        </div>
        <div class="step-body">
          <form
            id="upload-form"
            method="post"
            action="/app/claims/{{ claim.id }}/upload"
            enctype="multipart/form-data"
            hx-post="/app/claims/{{ claim.id }}/upload"
            hx-encoding="multipart/form-data"
            hx-target="#upload-status"
            hx-swap="innerHTML"
            hx-indicator="#upload-indicator"
          >
            <div id="dropzone" class="dropzone">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>Drop files or click to browse</span>
            </div>
            <input id="file-input" type="file" name="uploads" multiple accept=".pdf,.zip,.eml,.msg,.txt,.md,.html,.htm,image/*,text/plain,text/html,message/rfc822" style="display:none;" />
            <div id="selected-files" class="selected-files"></div>
            <div class="btn-row mt-1">
              <button class="btn btn-sm" type="submit">Upload</button>
              <button type="button" class="btn btn-sm" id="clear-files" style="display:none;">Clear</button>
              <span id="upload-indicator" class="muted htmx-indicator" style="font-size:12px;">Uploading…</span>
            </div>
          </form>
          <div id="upload-status" class="muted" style="font-size:12px; margin-top:8px;"></div>
          <script>
            (function() {
              const dz = document.getElementById('dropzone');
              const input = document.getElementById('file-input');
              const selected = document.getElementById('selected-files');
              const clearBtn = document.getElementById('clear-files');
              if (!dz || !input) return;
              
              let allFiles = [];
              
              dz.addEventListener('click', () => input.click());
              dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dropzone--active'); });
              dz.addEventListener('dragleave', () => dz.classList.remove('dropzone--active'));
              dz.addEventListener('drop', (e) => { 
                e.preventDefault(); 
                dz.classList.remove('dropzone--active'); 
                if (e.dataTransfer?.files) addFiles(e.dataTransfer.files);
              });
              input.addEventListener('change', () => addFiles(input.files));
              if (clearBtn) clearBtn.addEventListener('click', clearFiles);
              
              function addFiles(fileList) {
                for (const f of fileList) {
                  if (!allFiles.some(x => x.name === f.name && x.size === f.size)) {
                    allFiles.push(f);
                  }
                }
                syncInput();
                updateDisplay();
              }
              
              function clearFiles() {
                allFiles = [];
                syncInput();
                updateDisplay();
              }
              
              function syncInput() {
                const dt = new DataTransfer();
                allFiles.forEach(f => dt.items.add(f));
                input.files = dt.files;
              }
              
              function updateDisplay() {
                if (!selected) return;
                if (clearBtn) clearBtn.style.display = allFiles.length ? 'inline-flex' : 'none';
                if (allFiles.length === 0) {
                  selected.innerHTML = '';
                  return;
                }
                selected.innerHTML = allFiles.map(f => 
                  `<div class="selected-file">${f.name} <span class="muted">(${(f.size/1024).toFixed(1)} KB)</span></div>`
                ).join('');
              }
            })();
          </script>
          {% include "claim_detail/_docs_list.html" %}
        </div>
      </div>

      {% include "claim_detail/_expenses_section.html" %}
      {% include "claim_detail/_policy_section.html" %}

    </div>

    <!-- Sidebar -->
    <aside class="workspace-sidebar">

      <!-- Routing -->
      {% if user.role.value == 'ADMIN' %}
      <div class="sidebar-card">
        <h3 class="sidebar-label">Routing</h3>
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          Approver:
          {% if claim.approver and claim.approver.email %}
            {{ claim.approver.email }}
          {% elif claim.approver_id %}
            {{ claim.approver_id }}
          {% else %}
            —
          {% endif %}
        </div>
        <form method="post" action="/app/claims/{{ claim.id }}/route" class="compact-form">
          <div class="form-field">
            <label>Assign to</label>
            <select name="approver_id" required>
              <option value="" disabled {% if not claim.approver_id %}selected{% endif %}>Select approver…</option>
              {% for a in route_targets %}
                <option value="{{ a.id }}" {% if claim.approver_id == a.id %}selected{% endif %}>
                  {{ a.email }}{% if a.role.value == 'ADMIN' %} (ADMIN){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-sm" type="submit" style="width:100%;">
            {% if claim.status.value == 'SUBMITTED' %}Route to approver{% else %}Update approver{% endif %}
          </button>
        </form>
        {% if claim.status.value == 'SUBMITTED' and not claim.approver_id %}
          <div class="callout warning mt-1">Submitted but not routed to an approver yet.</div>
        {% endif %}
      </div>
      {% endif %}

      <!-- FX Rates -->
      {% include "claim_detail/_fx_card.html" %}

      <!-- Downloads (after export) -->
      {% if exports|length > 0 %}
      <div class="sidebar-card">
        <h3 class="sidebar-label">Downloads</h3>
        <div class="export-links">
          {% for e in exports %}
            {% if e.status.value == 'COMPLETED' %}
              {% if e.summary_xlsx_key %}<a href="/app/exports/{{ e.id }}/download/summary" class="export-link">Summary.xlsx</a>{% endif %}
              {% if e.supporting_pdf_key %}<a href="/app/exports/{{ e.id }}/download/supporting" class="export-link">Supporting_Documents.pdf</a>{% elif e.supporting_zip_key %}<a href="/app/exports/{{ e.id }}/download/supporting" class="export-link">Supporting_Documents.zip</a>{% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Actions -->
      <div class="sidebar-card sidebar-card--muted">
        {% if user.role.value in ['APPROVER','ADMIN'] and claim.status.value == 'NEEDS_APPROVER_REVIEW' %}
          <form method="post" action="/app/claims/{{ claim.id }}/reject" class="mb-1">
            <button class="btn btn-sm" type="submit" style="width:100%; color:var(--danger);">Reject</button>
          </form>
        {% endif %}
        {% if claim.status.value in ['DRAFT', 'PROCESSING', 'NEEDS_EMPLOYEE_REVIEW'] %}
          <form method="post" action="/app/claims/{{ claim.id }}/delete" onsubmit="return confirm('Delete this claim?');">
            <button class="btn btn-sm" type="submit" style="width:100%; color:var(--danger);">Delete claim</button>
          </form>
        {% endif %}
      </div>

    </aside>
  </div>

  <div id="expense-drawer" class="drawer" aria-hidden="true">
    <div class="drawer-backdrop" data-drawer-close></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Expense details">
      <div id="drawer-content">
        <div class="muted">Select an item to review.</div>
      </div>
    </div>
  </div>

  {% include "claim_detail/_live_poll.html" %}

<style>
.claim-header { display:flex; justify-content:space-between; align-items:flex-start; gap:24px; margin-bottom:32px; flex-wrap:wrap; }
.claim-meta { display:flex; align-items:center; gap:10px; margin-top:6px; flex-wrap:wrap; }
.breadcrumb-link { display:inline-flex; align-items:center; gap:4px; font-size:13px; color:var(--text-muted); text-decoration:none; }
.breadcrumb-link:hover { color:var(--text-primary); text-decoration:none; }

.workspace { display:grid; grid-template-columns:1fr 260px; gap:32px; align-items:start; }
@media (max-width:900px) { .workspace { grid-template-columns:1fr; } }
.workspace-main { display:flex; flex-direction:column; gap:20px; }
.workspace-sidebar { display:flex; flex-direction:column; gap:16px; }

.step-card { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius); }
.step-header { display:flex; align-items:center; gap:12px; padding:16px 20px; cursor:pointer; }
.step-header::-webkit-details-marker { display:none; }
details.step-card > .step-header { list-style:none; }
.step-number { width:24px; height:24px; border-radius:50%; background:var(--accent-bg); color:var(--accent); font-size:12px; font-weight:600; display:flex; align-items:center; justify-content:center; }
.step-title { font-weight:500; color:var(--text-primary); }
.step-body { padding:0 20px 20px; }

.sidebar-card { background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:var(--radius); padding:16px; }
.sidebar-card--muted { background:var(--bg-elevated); }
.sidebar-label { font-size:11px; font-weight:600; letter-spacing:0.05em; text-transform:uppercase; color:var(--text-muted); margin:0 0 12px; }

.compact-form .form-field { margin-bottom:12px; }
.compact-form .form-field label { font-size:11px; font-weight:500; color:var(--text-secondary); margin-bottom:4px; display:block; }
.compact-form input, .compact-form select { font-size:13px; padding:8px 10px; }
.form-grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.form-grid-3 { display:grid; grid-template-columns:1fr 1fr 2fr; gap:12px; }
.form-grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
@media (max-width:700px) { .form-grid-3, .form-grid-4 { grid-template-columns:1fr 1fr; } }

.dropzone { border:2px dashed var(--border-standard); border-radius:var(--radius-sm); padding:24px; text-align:center; cursor:pointer; background:var(--bg-elevated); display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); font-size:13px; transition:all 0.15s; }
.dropzone:hover, .dropzone--active { border-color:var(--accent); background:var(--accent-bg); }
.dropzone svg { opacity:0.4; }
.selected-files { margin-top:8px; display:flex; flex-direction:column; gap:4px; }
.selected-file { font-size:12px; padding:6px 10px; background:var(--accent-bg); border-radius:4px; color:var(--text-primary); }

.file-list { margin-top:12px; display:flex; flex-direction:column; gap:6px; }
.file-item { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--bg-elevated); border-radius:6px; font-size:13px; }
.file-item a { color:var(--accent); font-weight:500; }

.expenses-table { border:1px solid var(--border-subtle); border-radius:var(--radius-sm); overflow:hidden; margin-top:8px; }
.expenses-header, .expense-row { display:grid; grid-template-columns:80px 120px 1fr 110px 90px 160px; gap:8px; padding:10px 14px; align-items:center; font-size:13px; }
.expenses-header { background:var(--bg-elevated); font-size:10px; font-weight:600; letter-spacing:0.04em; text-transform:uppercase; color:var(--text-muted); }
.expense-row { border-top:1px solid var(--border-subtle); }
.expense-row:hover { background:var(--bg-hover); }
.link-muted { color:var(--text-muted); font-size:12px; }
.link-muted:hover { color:var(--accent); }

.edit-panel { background:var(--accent-bg); border:1px solid var(--accent-border); border-radius:var(--radius-sm); padding:16px; }
.edit-panel-header { display:flex; justify-content:space-between; margin-bottom:12px; }

.policy-summary-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.policy-issues { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
.policy-issue { background:var(--bg-elevated); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:12px 14px; }
.policy-issue--resolved { opacity:0.8; }
.policy-issue-top { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
.policy-issue-badges { display:flex; gap:6px; flex-wrap:wrap; }
.policy-issue-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
.policy-issue-title { font-weight:600; color:var(--text-primary); margin-top:8px; }
.policy-issue-item { margin-top:8px; }
.policy-subtitle { font-size:11px; font-weight:600; letter-spacing:0.05em; text-transform:uppercase; color:var(--text-muted); margin-top:16px; }

.task-list { display:flex; flex-direction:column; gap:8px; }
.task-item { display:flex; justify-content:space-between; align-items:center; font-size:13px; padding:6px 0; border-bottom:1px solid var(--border-subtle); }
.task-item:last-child { border-bottom:none; }

.fx-form { margin-top:8px; }
.fx-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.fx-row label { width:36px; font-size:12px; font-weight:500; color:var(--text-muted); }
.fx-row input { flex:1; font-size:13px; padding:6px 8px; }

.export-links { display:flex; flex-direction:column; gap:6px; }
.export-link { font-size:13px; color:var(--accent); }

.empty-text { color:var(--text-muted); font-size:13px; margin:0; }
.btn-xs { font-size:11px; padding:4px 8px; }
</style>
{% endblock %}
