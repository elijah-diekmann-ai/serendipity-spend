{% extends "base.html" %}
{% block content %}
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="/app" class="breadcrumb-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Back to Claims
    </a>
  </div>

  <!-- Header -->
  <div class="claim-header">
    <div class="claim-header-main">
      <h1 class="page-title">Claim #{{ claim.id|string|truncate(8, True, '') }}</h1>
      <div class="claim-meta">
        {% if claim.status.value == 'DRAFT' %}
          <span class="pill">Draft</span>
        {% elif claim.status.value == 'APPROVED' %}
          <span class="pill ok">Approved</span>
        {% elif claim.status.value == 'REJECTED' %}
          <span class="pill bad">Rejected</span>
        {% elif 'REVIEW' in claim.status.value %}
          <span class="pill warn">In Review</span>
        {% else %}
          <span class="pill info">{{ claim.status.value }}</span>
        {% endif %}
        <span class="text-secondary">{{ claim.home_currency }}</span>
        {% if claim.travel_start_date and claim.travel_end_date %}
          <span class="muted">{{ claim.travel_start_date }} → {{ claim.travel_end_date }}</span>
        {% endif %}
      </div>
    </div>
    <div class="btn-row">
      {% if user.role.value == 'ADMIN' and not claim.approver_id %}
        <form method="post" action="/app/claims/{{ claim.id }}/route-to-me">
          <button class="btn" type="submit">Route to me</button>
        </form>
      {% endif %}
      {% if claim.status.value == 'DRAFT' %}
        <form method="post" action="/app/claims/{{ claim.id }}/submit">
          <button class="btn btn-accent" type="submit">Submit for Review</button>
        </form>
      {% endif %}
      <form method="post" action="/app/claims/{{ claim.id }}/export">
        <button class="btn" type="submit">Export</button>
      </form>
      {% if user.role.value in ['APPROVER','ADMIN'] and claim.status.value == 'NEEDS_APPROVER_REVIEW' %}
        <form method="post" action="/app/claims/{{ claim.id }}/approve">
          <button class="btn btn-primary" type="submit">Approve</button>
        </form>
        <form method="post" action="/app/claims/{{ claim.id }}/request-changes">
          <button class="btn" type="submit">Request changes</button>
        </form>
        <form method="post" action="/app/claims/{{ claim.id }}/reject">
          <button class="btn btn-danger" type="submit">Reject</button>
        </form>
      {% endif %}
      {% if claim.status.value == 'DRAFT' %}
        <form method="post" action="/app/claims/{{ claim.id }}/delete" onsubmit="return confirm('Delete this claim? This cannot be undone.');">
          <button class="btn btn-danger" type="submit">Delete</button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Alerts -->
  {% if violations|length > 0 %}
  <div class="alerts-bar">
    {% for v in violations %}
      {% if v.status.value != 'RESOLVED' %}
        <div class="alert-item {% if v.severity.value == 'FAIL' %}alert-item--error{% else %}alert-item--warn{% endif %}">
          {{ v.title }}
        </div>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- Main workspace -->
  <div class="workspace">
    <!-- Left column: Details & Upload -->
    <div class="workspace-main">
      
      <!-- Trip Details Section -->
      <section class="section">
        <h2 class="section-label">Trip Details</h2>
        <form method="post" action="/app/claims/{{ claim.id }}/update" class="details-form">
          <div class="form-row">
            <div class="form-field">
              <label>Start Date</label>
              <input type="date" name="travel_start_date" value="{{ claim.travel_start_date or '' }}" />
            </div>
            <div class="form-field">
              <label>End Date</label>
              <input type="date" name="travel_end_date" value="{{ claim.travel_end_date or '' }}" />
            </div>
          </div>
          <div class="form-field">
            <label>Purpose of Trip</label>
            <textarea name="purpose" rows="3" placeholder="Describe the business purpose...">{{ claim.purpose or '' }}</textarea>
          </div>
          <button class="btn btn-sm" type="submit">Save</button>
        </form>
      </section>

      <!-- Upload Section -->
      <section class="section">
        <h2 class="section-label">Receipts & Documents</h2>
        <form method="post" action="/app/claims/{{ claim.id }}/upload" enctype="multipart/form-data">
          <div id="dropzone" class="dropzone">
            <div class="dropzone-content">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>Drop files here or click to browse</span>
              <span class="muted">PDF, images, ZIP, or .eml files</span>
            </div>
          </div>
          <input id="file-input" type="file" name="uploads" multiple accept=".pdf,.zip,.eml,image/*" required style="display:none;" />
          <button class="btn btn-accent mt-1" type="submit">Upload & Extract</button>
        </form>
        <script>
          (function() {
            const dz = document.getElementById('dropzone');
            const input = document.getElementById('file-input');
            if (!dz || !input) return;
            dz.addEventListener('click', () => input.click());
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dropzone--active'); });
            dz.addEventListener('dragleave', () => dz.classList.remove('dropzone--active'));
            dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('dropzone--active'); if (e.dataTransfer && e.dataTransfer.files) input.files = e.dataTransfer.files; });
            input.addEventListener('change', () => {
              const c = dz.querySelector('.dropzone-content span');
              const count = (input.files && input.files.length) ? input.files.length : 0;
              if (c) c.textContent = count ? (count + ' file(s) selected') : 'Drop files here or click to browse';
            });
          })();
        </script>

        {% if docs|length > 0 %}
        <div class="file-list">
          {% for d in docs %}
            <div class="file-item">
              <a href="/app/documents/{{ d.id }}/download" class="file-name">{{ d.filename }}</a>
              {% if d.status.value == 'PROCESSED' %}
                <span class="pill ok">Processed</span>
              {% elif d.status.value == 'FAILED' %}
                <span class="pill bad">Failed</span>
              {% elif d.status.value == 'PROCESSING' %}
                <span class="pill info">Processing...</span>
              {% else %}
                <span class="pill">{{ d.status.value }}</span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        {% endif %}
      </section>

      <!-- Expense Items Section -->
      <section class="section">
        <h2 class="section-label">Expense Items</h2>
        <div class="callout mt-1">
          Add missing items manually when a receipt isn't recognized.
        </div>

        <form method="post" action="/app/claims/{{ claim.id }}/items/new" class="details-form mt-1">
          <div class="form-row">
            <div class="form-field">
              <label>Vendor</label>
              <input name="vendor" placeholder="e.g. Marriott, Delta, Restaurant" required />
            </div>
            <div class="form-field">
              <label>Date</label>
              <input type="date" name="transaction_date" />
            </div>
          </div>
          <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="form-field">
              <label>Category</label>
              <select name="category">
                <option value="">—</option>
                {% for c in expense_categories %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label>Amount</label>
              <input name="amount_original_amount" placeholder="e.g. 123.45" required />
            </div>
            <div class="form-field">
              <label>Currency</label>
              <select name="amount_original_currency" required>
                {% for cur in currency_options %}
                  <option value="{{ cur }}" {% if cur == claim.home_currency %}selected{% endif %}>{{ cur }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="form-field">
            <label>Description</label>
            <input name="description" placeholder="Optional notes (e.g., dinner with client)" />
          </div>

          <details class="mt-1">
            <summary class="muted">Policy details (optional)</summary>
            <div class="form-row mt-1" style="grid-template-columns: 1fr 1fr;">
              <div class="form-field">
                <label>Hotel nights</label>
                <input name="hotel_nights" placeholder="e.g. 2" />
              </div>
              <div class="form-field">
                <label>Meal attendees (if applicable)</label>
                <input name="attendees" placeholder="Names or count" />
              </div>
            </div>
            <div class="form-row" style="grid-template-columns: 1fr 1fr;">
              <div class="form-field">
                <label>Flight duration (hours)</label>
                <input name="flight_duration_hours" placeholder="e.g. 5.5" />
              </div>
              <div class="form-field">
                <label>Flight cabin class</label>
                <select name="flight_cabin_class">
                  <option value="">—</option>
                  <option value="economy">economy</option>
                  <option value="premium_economy">premium_economy</option>
                  <option value="business">business</option>
                  <option value="first">first</option>
                </select>
              </div>
            </div>
          </details>

          <div class="mt-1">
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" name="employee_reviewed" checked />
              Mark reviewed
            </label>
          </div>

          <button class="btn btn-sm mt-1" type="submit">Add item</button>
        </form>

        {% if edit_item %}
          <div id="edit-item" class="callout mt-2">
            Editing item: <span class="mono">{{ edit_item.id }}</span>
            <a href="/app/claims/{{ claim.id }}" class="muted" style="margin-left: 10px;">Cancel</a>
          </div>
          <form method="post" action="/app/claims/{{ claim.id }}/items/{{ edit_item.id }}/update" class="details-form mt-1">
            <div class="form-row">
              <div class="form-field">
                <label>Vendor</label>
                <input name="vendor" value="{{ edit_item.vendor }}" required />
              </div>
              <div class="form-field">
                <label>Date</label>
                <input type="date" name="transaction_date" value="{{ edit_item.transaction_date or '' }}" />
              </div>
            </div>
            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
              <div class="form-field">
                <label>Category</label>
                <select name="category">
                  <option value="">—</option>
                  {% for c in expense_categories %}
                    <option value="{{ c }}" {% if edit_item.category == c %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label>Amount</label>
                <input name="amount_original_amount" value="{{ '%.2f'|format(edit_item.amount_original_amount) }}" required />
              </div>
              <div class="form-field">
                <label>Currency</label>
                <select name="amount_original_currency" required>
                  {% for cur in currency_options %}
                    <option value="{{ cur }}" {% if cur == edit_item.amount_original_currency %}selected{% endif %}>{{ cur }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-field">
              <label>Description</label>
              <input name="description" value="{{ edit_item.description or '' }}" />
            </div>

            <details class="mt-1" open>
              <summary class="muted">Policy details</summary>
              <div class="form-row mt-1" style="grid-template-columns: 1fr 1fr;">
                <div class="form-field">
                  <label>Hotel nights</label>
                  <input name="hotel_nights" value="{{ edit_item.metadata_json.get('hotel_nights', '') }}" />
                </div>
                <div class="form-field">
                  <label>Meal attendees</label>
                  <input name="attendees" value="{{ edit_item.metadata_json.get('attendees', '') }}" />
                </div>
              </div>
              <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                <div class="form-field">
                  <label>Flight duration (hours)</label>
                  <input name="flight_duration_hours" value="{{ edit_item.metadata_json.get('flight_duration_hours', '') }}" />
                </div>
                <div class="form-field">
                  <label>Flight cabin class</label>
                  <select name="flight_cabin_class">
                    <option value="">—</option>
                    {% set cabin = edit_item.metadata_json.get('flight_cabin_class', '') %}
                    <option value="economy" {% if cabin == 'economy' %}selected{% endif %}>economy</option>
                    <option value="premium_economy" {% if cabin == 'premium_economy' %}selected{% endif %}>premium_economy</option>
                    <option value="business" {% if cabin == 'business' %}selected{% endif %}>business</option>
                    <option value="first" {% if cabin == 'first' %}selected{% endif %}>first</option>
                  </select>
                </div>
              </div>
            </details>

            <div class="mt-1">
              <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" name="employee_reviewed" {% if edit_item.metadata_json.get('employee_reviewed') %}checked{% endif %} />
                Mark reviewed
              </label>
            </div>

            <div class="btn-row mt-1">
              <button class="btn btn-sm btn-primary" type="submit">Save item</button>
            </div>
          </form>
          <form method="post" action="/app/claims/{{ claim.id }}/items/{{ edit_item.id }}/delete" onsubmit="return confirm('Delete this item?');" class="mt-1">
            <button class="btn btn-sm btn-danger" type="submit">Delete</button>
          </form>
        {% endif %}

        {% if items|length == 0 %}
          <p class="empty-text">No items yet. Upload receipts to extract expenses.</p>
        {% else %}
          <div class="expenses-table">
            <div class="expenses-header">
              <span>Date</span>
              <span>Vendor</span>
              <span>Description</span>
              <span class="text-right">Amount</span>
              <span class="text-right">{{ claim.home_currency }}</span>
              <span class="text-right">Edit</span>
            </div>
            {% for i in items %}
              <div class="expense-row">
                <span class="muted">{{ i.transaction_date or '—' }}</span>
                <span>{{ i.vendor }}</span>
                <span class="muted">{{ i.description or '—' }}</span>
                <span class="text-right mono">{{ i.amount_original_currency }} {{ '%.2f'|format(i.amount_original_amount) }}</span>
                <span class="text-right mono">
                  {% if i.amount_home_amount is not none %}
                    {{ '%.2f'|format(i.amount_home_amount) }}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </span>
                <span class="text-right">
                  <a class="btn btn-sm" href="/app/claims/{{ claim.id }}?edit_item_id={{ i.id }}#edit-item">Edit</a>
                </span>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </section>

    </div>

    <!-- Right column: Tasks & FX -->
    <aside class="workspace-sidebar">
      
      <!-- Tasks -->
      <section class="sidebar-section">
        <h3 class="sidebar-label">To Do</h3>
        {% if tasks|length == 0 %}
          <p class="empty-text">No tasks</p>
        {% else %}
          <div class="task-list">
            {% for t in tasks %}
              <div class="task-item {% if t.status.value == 'RESOLVED' %}task-item--done{% endif %}">
                <div style="flex:1;">
                  <span class="task-title">{{ t.title }}</span>
                  {% if t.description %}
                    <div class="muted" style="margin-top: 2px;">{{ t.description }}</div>
                  {% endif %}
                </div>
                {% if t.status.value == 'OPEN' %}
                  <form method="post" action="/app/tasks/{{ t.id }}/resolve">
                    <input type="hidden" name="claim_id" value="{{ claim.id }}" />
                    <button class="btn btn-sm" type="submit">Done</button>
                  </form>
                {% else %}
                  <span class="pill ok">Done</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </section>

      <!-- FX Rates -->
      <section class="sidebar-section">
        <h3 class="sidebar-label">FX Rates</h3>
        <form method="post" action="/app/claims/{{ claim.id }}/fx">
          <div class="form-field">
            <label>USD → {{ claim.home_currency }}</label>
            <input name="usd_to_home" placeholder="e.g. 1.35" />
          </div>
          <div class="form-field">
            <label>CAD → {{ claim.home_currency }}</label>
            <input name="cad_to_home" placeholder="e.g. 1.00" />
          </div>
          <div class="form-field">
            <label>GBP → {{ claim.home_currency }}</label>
            <input name="gbp_to_home" placeholder="e.g. 1.70" />
          </div>
          <div class="form-field">
            <label>EUR → {{ claim.home_currency }}</label>
            <input name="eur_to_home" placeholder="e.g. 1.45" />
          </div>
          <button class="btn btn-sm" type="submit">Save</button>
        </form>
      </section>

      <!-- Exports -->
      <section class="sidebar-section">
        <h3 class="sidebar-label">Exports</h3>
        {% if exports|length == 0 %}
          <p class="empty-text">No exports yet</p>
        {% else %}
          <div class="export-list">
            {% for e in exports %}
              <div class="export-item">
                {% if e.status.value == 'COMPLETED' %}
                  {% if e.summary_xlsx_key %}
                    <a class="btn btn-sm" href="/app/exports/{{ e.id }}/download/summary">Summary.xlsx</a>
                  {% endif %}
                  {% if e.supporting_zip_key %}
                    <a class="btn btn-sm" href="/app/exports/{{ e.id }}/download/supporting">Documents.zip</a>
                  {% endif %}
                {% elif e.status.value == 'FAILED' %}
                  <span class="pill bad">Export failed</span>
                {% else %}
                  <span class="pill">{{ e.status.value }}</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </section>

    </aside>
  </div>

<style>
/* Claim Detail Workspace Styles */
.breadcrumb {
  margin-bottom: 20px;
}

.breadcrumb-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  transition: color 0.15s ease;
}

.breadcrumb-link:hover {
  color: var(--text-primary);
  text-decoration: none;
}

.claim-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 24px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.claim-header-main { flex: 1; }

.claim-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.alerts-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 24px;
}

.alert-item {
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
}

.alert-item--error {
  background: var(--danger-bg);
  color: var(--danger);
  border: 1px solid var(--danger-border);
}

.alert-item--warn {
  background: var(--warn-bg);
  color: var(--warn);
  border: 1px solid var(--warn-border);
}

.workspace {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 32px;
  align-items: start;
}

@media (max-width: 900px) {
  .workspace {
    grid-template-columns: 1fr;
  }
}

.workspace-main {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.workspace-sidebar {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.section { }

.section-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 16px;
}

.sidebar-section {
  background: var(--bg-elevated);
  border-radius: var(--radius);
  padding: 16px;
}

.sidebar-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin: 0 0 12px 0;
}

.details-form .form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.details-form .form-field {
  margin-bottom: 16px;
}

.details-form textarea {
  min-height: 80px;
}

.dropzone {
  border: 2px dashed var(--border-standard);
  border-radius: var(--radius);
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.15s ease;
  background: var(--bg-elevated);
}

.dropzone:hover,
.dropzone--active {
  border-color: var(--accent);
  background: var(--accent-bg);
}

.dropzone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
}

.dropzone-content svg {
  opacity: 0.5;
}

.file-list {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-surface);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
}

.file-name {
  color: var(--accent);
  font-weight: 500;
}

.expenses-table {
  border: 1px solid var(--border-standard);
  border-radius: var(--radius);
  overflow: hidden;
}

.expenses-header,
.expense-row {
  display: grid;
  grid-template-columns: 90px 120px 1fr 100px 80px 70px;
  gap: 12px;
  padding: 12px 16px;
  align-items: center;
}

.expenses-header {
  background: var(--bg-elevated);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.expense-row {
  border-top: 1px solid var(--border-subtle);
  font-size: 13px;
}

.expense-row:hover {
  background: var(--bg-hover);
}

.empty-text {
  color: var(--text-muted);
  font-size: 13px;
  margin: 0;
}

.task-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.task-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border-subtle);
}

.task-item:last-child {
  border-bottom: none;
}

.task-item--done .task-title {
  text-decoration: line-through;
  color: var(--text-muted);
}

.task-title {
  font-size: 13px;
  flex: 1;
}

.sidebar-section .form-field {
  margin-bottom: 12px;
}

.sidebar-section input {
  font-size: 13px;
  padding: 8px 10px;
}

.export-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.export-item {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
</style>
{% endblock %}
