{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <div class="panel-header">
      <div>
        <h1 class="title">Claim {{ claim.id }}</h1>
        <p class="subtitle">
          Status: <span class="pill"><span class="dot ok"></span>{{ claim.status.value }}</span>
          <span class="muted">
            · Home currency: {{ claim.home_currency }}
            · Approver: {{ claim.approver_id or '—' }}
          </span>
        </p>
      </div>
      <div class="btn-row">
        {% if user.role.value == 'ADMIN' and not claim.approver_id %}
          <form method="post" action="/app/claims/{{ claim.id }}/route-to-me">
            <button class="btn btn-ghost" type="submit">Route to me</button>
          </form>
        {% endif %}
        <form method="post" action="/app/claims/{{ claim.id }}/submit">
          <button class="btn" type="submit">Submit</button>
        </form>
        <form method="post" action="/app/claims/{{ claim.id }}/export">
          <button class="btn btn-ghost" type="submit">Generate export</button>
        </form>
        {% if user.role.value in ['APPROVER','ADMIN'] and claim.status.value == 'NEEDS_APPROVER_REVIEW' %}
          <form method="post" action="/app/claims/{{ claim.id }}/approve"><button class="btn" type="submit">Approve</button></form>
          <form method="post" action="/app/claims/{{ claim.id }}/request-changes"><button class="btn btn-ghost" type="submit">Request changes</button></form>
          <form method="post" action="/app/claims/{{ claim.id }}/reject"><button class="btn btn-danger" type="submit">Reject</button></form>
        {% endif %}
      </div>
    </div>
    <div class="panel-body">
      <div class="grid">
        <div class="panel" style="box-shadow:none;">
          <div class="panel-body">
            <h2 class="title" style="font-size: 14px;">Claim details</h2>
            <form method="post" action="/app/claims/{{ claim.id }}/update">
              <div style="margin-top: 10px;">
                <label>Travel start date</label>
                <input type="date" name="travel_start_date" value="{{ claim.travel_start_date or '' }}" />
              </div>
              <div style="margin-top: 10px;">
                <label>Travel end date</label>
                <input type="date" name="travel_end_date" value="{{ claim.travel_end_date or '' }}" />
              </div>
              <div style="margin-top: 10px;">
                <label>Purpose</label>
                <textarea name="purpose">{{ claim.purpose or '' }}</textarea>
              </div>
              <div style="margin-top: 10px;" class="btn-row">
                <button class="btn" type="submit">Save</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="panel-body">
            <h2 class="title" style="font-size: 14px;">Upload documents</h2>
            <form method="post" action="/app/claims/{{ claim.id }}/upload" enctype="multipart/form-data">
              <div style="margin-top: 10px;">
                <input type="file" name="upload" required />
              </div>
              <div style="margin-top: 10px;" class="btn-row">
                <button class="btn" type="submit">Upload & extract</button>
              </div>
            </form>
            <div style="margin-top: 12px;">
              <table class="table">
                <thead>
                  <tr><th>File</th><th>Status</th><th>SHA</th></tr>
                </thead>
                <tbody>
                  {% for d in docs %}
                    <tr>
                      <td class="muted"><a href="/app/documents/{{ d.id }}/download">{{ d.filename }}</a></td>
                      <td class="muted">{{ d.status.value }}</td>
                      <td class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">{{ d.sha256[:10] }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top: 14px;">
        <div class="panel" style="box-shadow:none;">
          <div class="panel-body">
            <h2 class="title" style="font-size: 14px;">Tasks</h2>
            {% if tasks|length == 0 %}
              <div class="callout">No tasks.</div>
            {% else %}
              <table class="table">
                <thead><tr><th>Status</th><th>Type</th><th>Title</th><th></th></tr></thead>
                <tbody>
                  {% for t in tasks %}
                    <tr>
                      <td class="muted">{{ t.status.value }}</td>
                      <td class="muted">{{ t.type }}</td>
                      <td>{{ t.title }}</td>
                      <td>
                        {% if t.status.value == 'OPEN' %}
                          <form method="post" action="/app/tasks/{{ t.id }}/resolve">
                            <input type="hidden" name="claim_id" value="{{ claim.id }}" />
                            <button class="btn btn-ghost" type="submit">Resolve</button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
            <div class="callout" style="margin-top: 10px;">
              Set FX rates for USD/CAD if you want reimbursement totals in {{ claim.home_currency }}.
            </div>
            <form method="post" action="/app/claims/{{ claim.id }}/fx" style="margin-top: 10px;">
              <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div>
                  <label>USD → {{ claim.home_currency }}</label>
                  <input name="usd_to_home" placeholder="e.g. 1.35" />
                </div>
                <div>
                  <label>CAD → {{ claim.home_currency }}</label>
                  <input name="cad_to_home" placeholder="e.g. 1.00" />
                </div>
              </div>
              <div class="btn-row" style="margin-top: 10px;">
                <button class="btn btn-ghost" type="submit">Save FX rates</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="panel-body">
            <h2 class="title" style="font-size: 14px;">Policy</h2>
            {% if violations|length == 0 %}
              <div class="callout">No policy results yet.</div>
            {% else %}
              <table class="table">
                <thead><tr><th>Status</th><th>Rule</th><th>Severity</th><th>Title</th></tr></thead>
                <tbody>
                  {% for v in violations %}
                    <tr>
                      <td class="muted">{{ v.status.value }}</td>
                      <td class="muted">{{ v.rule_id }}</td>
                      <td class="muted">{{ v.severity.value }}</td>
                      <td>{{ v.title }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 14px; box-shadow:none;">
        <div class="panel-body">
          <h2 class="title" style="font-size: 14px;">Expense items</h2>
          {% if items|length == 0 %}
            <div class="callout">No items yet. Upload a PDF to extract receipts.</div>
          {% else %}
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vendor</th>
                  <th>Description</th>
                  <th>Original</th>
                  <th>{{ claim.home_currency }}</th>
                </tr>
              </thead>
              <tbody>
                {% for i in items %}
                  <tr>
                    <td class="muted">{{ i.transaction_date or '—' }}</td>
                    <td class="muted">{{ i.vendor }}</td>
                    <td>{{ i.description or '—' }}</td>
                    <td class="muted">{{ i.amount_original_currency }} {{ '%.2f'|format(i.amount_original_amount) }}</td>
                    <td class="muted">
                      {% if i.amount_home_amount is not none %}
                        {{ claim.home_currency }} {{ '%.2f'|format(i.amount_home_amount) }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
      </div>

      <div class="panel" style="margin-top: 14px; box-shadow:none;">
        <div class="panel-body">
            <h2 class="title" style="font-size: 14px;">Exports</h2>
          {% if exports|length == 0 %}
            <div class="callout">No exports yet.</div>
          {% else %}
            <table class="table">
              <thead><tr><th>Status</th><th>Created</th><th>Artifacts</th></tr></thead>
              <tbody>
                {% for e in exports %}
                  <tr>
                    <td class="muted">{{ e.status.value }}</td>
                    <td class="muted">{{ e.created_at }}</td>
                    <td class="muted">
                      {% if e.summary_xlsx_key %}
                        <a class="pill" href="/app/exports/{{ e.id }}/download/summary">summary.xlsx</a>
                      {% endif %}
                      {% if e.supporting_zip_key %}
                        <a class="pill" href="/app/exports/{{ e.id }}/download/supporting">supporting.zip</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
